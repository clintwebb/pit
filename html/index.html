<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Private-Key Infrastructure Toolbox">
    <meta name="author" content="Clinton Webb">
    <title>PIT</title>

    <!-- Bootstrap core CSS -->
    <link href="/css/vendor/bootstrap.min.css" rel="stylesheet">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>


    <link href="/css/dashboard.css"       rel="stylesheet">
  </head>
  <body>
    

<!-- animated loading overlay -->
<div class="loader"></div>

<div id="intro">
    <div class="intro-header p-3 pb-md-4 mx-auto text-center">
        <h1 class="display-4 fw-normal">PIT</h1>
        <p class="fs-5 text-muted">Easily and securely store sensitive and private information, such as passwords, keys and certificates..</p>
    </div>

	<div class="form-signin">
		<form id="frm-signin">
			<h1 class="h3 mb-3 fw-normal">Welcome Back!</h1>

			<div class="form-floating">
				<input type="email" class="form-control" id="floatingInput" placeholder="name@example.com">
				<label for="floatingInput">Email address</label>
			</div>
			<div class="form-floating">
				<input type="password" class="form-control" id="floatingPassword" placeholder="Password">
				<label for="floatingPassword">Password</label>
			</div>
			<div class="checkbox mb-3">
				<label>
					<input type="checkbox" value="remember-me"> Remember me
				</label>
			</div>
			<button id="but-signin" class="w-100 btn btn-lg btn-primary" type="button">Sign in</button><br>
			or <a href="#" id="but-signup-inc">Create an Account</a>
		</form>
	</div>
	<div class="form-signup">
		<form id="frm-signup">
			<h1 class="h3 mb-3 fw-normal">Hello!!</h1>

			<div class="form-floating">
				<input type="email" class="form-control" id="frm-signup-email" name="email" placeholder="name@example.com">
				<label for="floatingInput">Email address</label>
			</div>
			<div class="form-floating">
				<input type="password" class="form-control" id="frm-signup-pass1" name="password" placeholder="Password">
				<label for="floatingPassword">Password</label>
			</div>
			<div class="checkbox mb-3">
				<label>
					<input type="checkbox" value="remember-me"> Remember me
				</label>
			</div>
			<button id="but-signup" class="w-100 btn btn-lg btn-primary" type="button">Create Account</button><br>
			or <a href="#" id="but-signup-cancel">Cancel</a>
		</form>
	</div>
	<div class="form-signup-verify">
		<form id="frm-signup-verify">
			<h1 class="h3 mb-3 fw-normal">Hello!!</h1>
            <p>Please enter your password again, to ensure it is correct.</p>
            <p>Note that a failed password cannot be recovered</p>

			<div class="form-floating">
				<input type="password" class="form-control" id="frm-signup-pass2" name="password" placeholder="Password">
				<label for="floatingPassword">Password</label>
			</div>
			<button id="but-signup-verify" class="w-100 btn btn-lg btn-primary" type="button">Create Account</button><br>
			or <a href="#" id="but-signup-verify-cancel">Cancel</a>
		</form>
	</div>
</div> <!-- intro -->


<div id="main">

<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
  <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">PIT</a>
  <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <input class="form-control form-control-dark w-100" type="text" placeholder="Search" aria-label="Search">
  <ul class="navbar-nav px-3">
    <li class="nav-item text-nowrap">
      <a id="but-signout" class="nav-link" href="#">Sign out</a>
    </li>
  </ul>
</header>

<div id="dashboard" class="container-fluid">
  <div class="row">
    <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">
              <span data-feather="home"></span>
              Vault
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <span data-feather="layers"></span>
              PKI
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <span data-feather="users"></span>
              People
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <span data-feather="play"></span>
              Actions
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <span data-feather="message-circle"></span>
              Notifications
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <span data-feather="settings"></span>
              Settings
            </a>
          </li>
        </ul>

        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>Organisations</span>
          <a class="link-secondary" href="#" aria-label="Add an Organisation">
            <span data-feather="plus-circle"></span>
          </a>
        </h6>
        <ul class="nav flex-column mb-2">
          <li class="nav-item">
            <a class="nav-link" href="#">
              <span data-feather="package"></span>
              Current User
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <span data-feather="package"></span>
              Non-Production
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <span data-feather="package"></span>
              Production
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <span data-feather="package"></span>
              Happy Birthday
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Dashboard</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
          <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
            <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
            <span data-feather="calendar"></span>
            This week
          </button>
        </div>
      </div>

      <h2>Section title</h2>
      <div class="table-responsive">
        <table class="table table-striped table-sm">
          <thead>
            <tr>
              <th>#</th>
              <th>Header</th>
              <th>Header</th>
              <th>Header</th>
              <th>Header</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1,001</td>
              <td>random</td>
              <td>data</td>
              <td>placeholder</td>
              <td>text</td>
            </tr>
            <tr>
              <td>1,002</td>
              <td>placeholder</td>
              <td>irrelevant</td>
              <td>visual</td>
              <td>layout</td>
            </tr>
            <tr>
              <td>1,003</td>
              <td>data</td>
              <td>rich</td>
              <td>dashboard</td>
              <td>tabular</td>
            </tr>
            <tr>
              <td>1,003</td>
              <td>information</td>
              <td>placeholder</td>
              <td>illustrative</td>
              <td>data</td>
            </tr>
            <tr>
              <td>1,004</td>
              <td>text</td>
              <td>random</td>
              <td>layout</td>
              <td>dashboard</td>
            </tr>
            <tr>
              <td>1,005</td>
              <td>dashboard</td>
              <td>irrelevant</td>
              <td>text</td>
              <td>placeholder</td>
            </tr>
            <tr>
              <td>1,006</td>
              <td>dashboard</td>
              <td>illustrative</td>
              <td>rich</td>
              <td>data</td>
            </tr>
            <tr>
              <td>1,007</td>
              <td>placeholder</td>
              <td>tabular</td>
              <td>information</td>
              <td>irrelevant</td>
            </tr>
            <tr>
              <td>1,008</td>
              <td>random</td>
              <td>data</td>
              <td>placeholder</td>
              <td>text</td>
            </tr>
            <tr>
              <td>1,009</td>
              <td>placeholder</td>
              <td>irrelevant</td>
              <td>visual</td>
              <td>layout</td>
            </tr>
            <tr>
              <td>1,010</td>
              <td>data</td>
              <td>rich</td>
              <td>dashboard</td>
              <td>tabular</td>
            </tr>
            <tr>
              <td>1,011</td>
              <td>information</td>
              <td>placeholder</td>
              <td>illustrative</td>
              <td>data</td>
            </tr>
            <tr>
              <td>1,012</td>
              <td>text</td>
              <td>placeholder</td>
              <td>layout</td>
              <td>dashboard</td>
            </tr>
            <tr>
              <td>1,013</td>
              <td>dashboard</td>
              <td>irrelevant</td>
              <td>text</td>
              <td>visual</td>
            </tr>
            <tr>
              <td>1,014</td>
              <td>dashboard</td>
              <td>illustrative</td>
              <td>rich</td>
              <td>data</td>
            </tr>
            <tr>
              <td>1,015</td>
              <td>random</td>
              <td>tabular</td>
              <td>information</td>
              <td>text</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>
</div>
</div><!-- main -->


    <script src="/js/vendor/jquery-2.1.1.min.js"></script>
    <script src="/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js" integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE" crossorigin="anonymous"></script>
    <script src="/js/vendor/jsencrypt.min.js"></script>
    <script src="/js/vendor/base64.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <script src="/js/dashboard.js"></script>
    <script src="/js/sessions.js"></script>
    <script src="/js/packs.js"></script>
    <script src="/js/orgs.js"></script>
    <script>
		$(document).ready(function() {

			$("#but-signup").click(function() {
                $(".form-signin").hide();
                $(".form-signup").hide();

                $('#frm-signup-verify')[0].password.value = '';
                $(".form-signup-verify").show();
                $('#frm-signup-verify')[0].password.select();
			});

            $("#but-signin").click(function() {
				$("#intro").hide();
				$("#main").show();
			});

			$("#but-signup-inc").click(function() {
                $(".form-signin").hide();
                $(".form-signup").show();
                $('#frm-signup')[0].email.select();
			});
			$("#but-signin-inc").click(function() {
                $(".form-signin").show();
                $(".form-signup").hide();
			});

			$("#but-signout").click(function() {
				$("#main").hide();
				$("#intro").show();
			});

			$("#but-signup-cancel").click(function() {
                $(".form-signin").show();
                $(".form-signup").hide();
			});

			$("#but-signup-verify").click(function() {

                // check that the two passwords match.. if not, then do a quick alert, and take them back to the creation form (with email filled in).
                var inPass1 = $('#frm-signup-pass1').val();
                var inPass2 = $('#frm-signup-pass2').val();

                console.assert(inPass1 != null && inPass1.length > 0, "Password is empty");
                console.assert(inPass1 != null && inPass1.length > 0, "Password is empty");

                if (inPass1.localeCompare(inPass2) != 0) {
                    // the passwords dont match.
                    alert("Passwords dont match.  Please try again");
                    $('#frm-signup-verify')[0].password.value = '';
                    $('#frm-signup')[0].password.value = '';

                    $(".form-signup-verify").hide();
                    $(".form-signup").show();

                    $('#frm-signup')[0].password.select();
                }
                else {
                    // seems to match.

                    // activate the loading overlay.
                    $(".loader").show();

                    // establish the session
                    Session.check();

                    // The username and password entered by the user, will be hashed to generate a large string (Account-Guard).
                    var inEmail = $('#frm-signup-email').val();
                    var auth = CryptoJS.SHA256(inEmail + inPass1).toString();
                    console.assert(auth.length > 0);

//                  A private/public key pair for the user is generated in the browser.
                    var crypt = new JSEncrypt({default_key_size: 2048});
                    crypt.getKey();

//                  A copy of the private key will be protected by that large string (passphrase).
                    var privkey  = crypt.getPrivateKey();
                    var pubkey   = crypt.getPublicKey();
                    var encprivkey = CryptoJS.AES.encrypt(privkey, auth).toString();
                    var guard = CryptoJS.SHA256(encprivkey).toString();
                    var guard_hash = CryptoJS.SHA256(guard + auth).toString();

                    var orgpack = Orgs.neworgpack(inEmail);



                    // generate an account-guard (just a hash of the encrypted private key).
                    var sdata = { 'g': guard, 'gh': guard_hash, 'pr': encprivkey, 'pub': pubkey, 'org': orgpack };
                    Session.send({
                        target: '/api/1/newaccount',
                        payload: sdata,
                        success: function(result) {
                            console.log("New Account Request done");

                            console.log("AAAA");
                            $(".loader").hide();
                        },
                        failure: function(result) {
                            console.log("Failed to create account");
                            alert("failed to create the account");
                            $(".loader").hide();
                        }
                    });

//                     Browser sends an account creation request, which includes:
//                     A copy of the Account-Guard data that has been hashed with the long-passphrase
//                     A copy of the raw Account-Guard data.
//                     A copy of the users-private key that has been protected by the long-passphrase
//                     Server receives this packet, creates an account with the very very basics. Nothing else is known about it, other than it is a unique account. The server doesn't know the username or the password. It doesn't even have the public key.
//                     This means that the server has a copy of the private-key for the account. But does not have a copy of the passphrase that was used to encrypt it. So it cannot use it. It is only storing it so that authentication can be done one browsers that do not have a copy of the key (ie, the user uses a different browser to access the service. They need to use their username and password correctly to obtain a copy of the private-key and to decrypt it)
//                     All the relevant information is stored in the browser storage.
//                     Since the account is new, a default Group pack will be created in the browser, encrypted and sent to the server. This will be the basis of all future changes and additions to the users stored information.
//                     Browser will then walk the user through setting up any additional information. They will be warned that unless they specifically request it, others wont have access to any of their details.
//                     Account details are saved on the server.

                }
			});


			$("#but-signup-verify-cancel").click(function() {
                $(".form-signin").show();
                $(".form-signup-verify").hide();
			});


			$(".loader").hide();
		});
	</script>

  </body>
</html>
